#
# ASMC benchmarking
#

trigger: none

pr: none

schedules:
- cron: "0 * * * *"
  displayName: Hourly next benchmark
  branches:
    include:
    - master
  always: true

jobs:

- job: RunEverything
  
  displayName: Master job to run all steps
  
  variables:
    benchDir: /home/fergus/asmc_temp/ASMC-benchmark
    buildDir: $(benchDir)/__asmc_build

  pool:
    name: 'singularity'

  steps:

  - checkout: none # don't actually check out source - we work on an existing directory

  - script: git pull
    workingDirectory: $(benchDir)
    displayName: Update asmc-benchmark repo

  - script: git submodule update --init --recursive
    workingDirectory: $(benchDir)
    displayName: Update ASMC submodule

  - script: mkdir -p $(benchDir)
    displayName: Create build directory

  - script: cmake ../ASMC -DCMAKE_BUILD_TYPE=Release
    workingDirectory: $(buildDir)
    displayName: CMake configure step

  - script: cmake --build . -j -- ASMC_exe
    workingDirectory: $(buildDir)
    displayName: CMake build step

  - script: python3 asmc-benchmark.py
    workingDirectory: $(benchDir)
    displayName: Run benchmark
    failOnStderr: true  # any printing to stderr results in a failure
    timeoutInMinutes: 45  # 0.75 hour failsafe on script

  - script: rm -rf $(buildDir)
    condition: always()
    displayName: Clean build directory
